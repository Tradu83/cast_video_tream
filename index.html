<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Custom Cast Receiver</title>
</head>
<body>
    <!-- Cast Receiver SDK -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        
        // Log khi receiver khởi động
        console.log('Cast Receiver: Initializing...');
        
        // Intercept LOAD message để đảm bảo MediaInfo được set đúng
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            loadRequestData => {
                try {
                    console.log('Cast Receiver: Load request received');
                    
                    const media = loadRequestData.media;
                    if (!media || !media.contentId) {
                        console.error('Cast Receiver: No content ID in load request');
                        return null;
                    }

                    const contentId = media.contentId;
                    console.log('Cast Receiver: Content URL:', contentId);
                    console.log('Cast Receiver: Content Type:', media.contentType);

                    // Đảm bảo streamType và contentType được set đúng
                    if (!media.streamType) {
                        // Mặc định là LIVE cho stream video
                        media.streamType = cast.framework.messages.StreamType.LIVE;
                        console.log('Cast Receiver: Set streamType to LIVE');
                    }
                    
                    if (!media.contentType) {
                        // Xác định contentType dựa trên URL
                        if (contentId.includes('.m3u8')) {
                            media.contentType = 'application/x-mpegURL';
                        } else if (contentId.includes('.mp4')) {
                            media.contentType = 'video/mp4';
                        } else {
                            media.contentType = 'application/x-mpegURL'; // Mặc định cho live stream
                        }
                        console.log('Cast Receiver: Set contentType to', media.contentType);
                    }

                    // Với M3U8, đảm bảo streamType là LIVE
                    if (contentId.includes('.m3u8')) {
                        media.streamType = cast.framework.messages.StreamType.LIVE;
                        media.contentType = 'application/x-mpegURL';
                        console.log('Cast Receiver: M3U8 detected, set streamType=LIVE, contentType=application/x-mpegURL');
                    }

                    console.log('Cast Receiver: Returning load request with streamType:', media.streamType, 'contentType:', media.contentType);
                    return loadRequestData;
                } catch (error) {
                    console.error('Cast Receiver: Error in LOAD interceptor:', error);
                    return null;
                }
            }
        );

        // Xử lý các sự kiện để debug
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
            () => {
                console.log('Cast Receiver: Player load complete');
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            (errorEvent) => {
                console.error('Cast Receiver: Player error:', errorEvent);
                if (errorEvent.detailedErrorCode) {
                    console.error('Cast Receiver: Error code:', errorEvent.detailedErrorCode);
                }
                if (errorEvent.error) {
                    console.error('Cast Receiver: Error object:', JSON.stringify(errorEvent.error));
                }
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_LOAD_START,
            () => {
                console.log('Cast Receiver: Player load start');
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_PRELOADING,
            () => {
                console.log('Cast Receiver: Player preloading');
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_PLAYING,
            () => {
                console.log('Cast Receiver: Player playing');
            }
        );

        // Khởi động receiver
        try {
            const options = new cast.framework.CastReceiverOptions();
            options.disableIdleTimeout = true;
            // Thêm log khi khởi động
            console.log('Cast Receiver: Starting with options:', JSON.stringify(options));
            context.start(options);
            console.log('Cast Receiver: Started successfully');
        } catch (error) {
            console.error('Cast Receiver: Error starting:', error);
            console.error('Cast Receiver: Error stack:', error.stack);
        }
    </script>
</body>
</html>
